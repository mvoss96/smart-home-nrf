<!DOCTYPE html>
<html>

<head>
    <title>Smart Home Devices</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f9f9f9;
        }

        .table-container {
            max-width: 100%;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }

        td ul {
            list-style-type: none;
            padding: 0;
            margin: 0 10px;
        }

        .small-font {
            font-size: 12px;
        }
    </style>
    <script>
        "use strict";
        window.onload = function () { fetchAndPopulate(); setInterval(fetchAndPopulate, 5000); }

        async function fetchAndPopulate() {
            try {
                const res = await fetch('http://127.0.0.1:5000/devices');
                const devices = await res.json();
                const table = document.getElementById('devicesTable');
                while (table.rows.length > 1) { table.deleteRow(1); }
                devices.forEach(device => populateTable(device, table));
            } catch (error) { console.error('Error:', error); }
        }

        function populateTable(device, table) {
            let row = table.insertRow();
            row.insertCell().innerHTML = `<span id="deviceName_${device.uuid}" class="device-name">
                ID:${device.id}<br>${device.name}<br><span class="small-font">(${device.type})</span>
                </span><button onclick="renameDevice('${device.uuid}')">Rename</button>
                <button onclick="removeDevice('${device.uuid}')">Remove</button>`;

            let statusList = document.createElement('ul');
            for (let prop in device.status) {
                let listItem = document.createElement('li');
                if (prop === "power") { listItem.textContent = `Power: ${device.status["power"] ? "on" : "Off"}`; }
                else { listItem.textContent = `${prop.charAt(0).toUpperCase() + prop.slice(1)}: ${device.status[prop]}`; }
                statusList.appendChild(listItem);
            }
            let statusCell = row.insertCell();
            statusCell.appendChild(statusList);
            row.insertCell().textContent = device.battery_powered ? Math.round(device.battery_level / 2.55) + '%' : 'N/A';
            row.insertCell().textContent = device.uuid.join(':');
            row.insertCell().textContent = device.version;
            row.insertCell().textContent = formatElapsedTime(device.last_seen);
        }

        function renameDevice(uuid) {
            uuid = uuid.replaceAll(",", "-");
            let newName = prompt("Enter new device name:");
            if (newName !== null) {
                fetch(`http://127.0.0.1:5000/devices/${uuid}/name`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName })
                }).then(response => {
                    if (!response.ok) {
                        throw new Error("HTTP error " + response.status);
                    }
                    fetchAndPopulate();
                }).catch(error => console.error('Error:', error));
            }
        }

        function removeDevice(uuid) {
            uuid = uuid.replaceAll(",", "-");
            if (confirm(`Do you want to remove Device ${uuid} ?`) == false) { return; }

            fetch(`http://127.0.0.1:5000/devices/${uuid}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: ""
            }).then(response => {
                if (!response.ok) {
                    throw new Error("HTTP error " + response.status);
                }
                fetchAndPopulate();
            }).catch(error => console.error('Error:', error));
        }

        function formatElapsedTime(last) {
            let currentTime = new Date();
            let elapsedTime = Math.floor((currentTime - new Date(last)) / 1000);
            return elapsedTime < 5 ? `< 5 s` : elapsedTime < 60 ? `${elapsedTime} s` :
                elapsedTime < 3600 ? `${Math.floor(elapsedTime / 60)} m` : `${Math.floor(elapsedTime / 3600)} h`;
        }
    </script>
</head>

<body>
    <h1>Smart Home Devices</h1>
    <div class="table-container">
        <table id="devicesTable">
            <thead>
                <tr>
                    <th>Device</th>
                    <th>Status</th>
                    <th>Battery Percentage</th>
                    <th>UUID</th>
                    <th>Firmware Version</th>
                    <th>Last Seen</th>
                </tr>
            </thead>
            <tbody>
                <!-- Devices will be dynamically inserted here -->
            </tbody>
        </table>
    </div>
</body>

</html>